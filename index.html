<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Procesador de Leads v8.3 - Parsing Fix & Edit</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- Fuentes -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 50%, #06b6d4 100%);
            background-attachment: fixed;
            color: #f1f5f9;
            min-height: 100vh;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            border-radius: 16px;
        }

        .glass-input {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.3s ease;
        }
        .glass-input:focus {
            background: rgba(0, 0, 0, 0.4);
            border-color: #22d3ee;
            outline: none;
            box-shadow: 0 0 0 2px rgba(34, 211, 238, 0.3);
        }
        .glass-input::placeholder { color: rgba(255, 255, 255, 0.5); }
        
        /* Select con fondo oscuro para que se lean las opciones */
        select.glass-input option {
            background-color: #1e293b;
            color: white;
        }

        .btn-action {
            background: linear-gradient(90deg, #0891b2 0%, #2563eb 100%);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-action:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(6, 182, 212, 0.4);
        }
        .btn-action:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-danger { background: linear-gradient(90deg, #be123c 0%, #e11d48 100%); }
        .btn-success { background: linear-gradient(90deg, #059669 0%, #10b981 100%); }
        .btn-secondary { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255,255,255,0.2); }

        .glass-table th {
            background: rgba(0, 0, 0, 0.3);
            color: #22d3ee;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }
        .glass-table tr {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: background 0.2s;
        }
        .glass-table tr:hover { background: rgba(255, 255, 255, 0.05); }
        .glass-table td { color: #e2e8f0; font-size: 0.9rem; }

        .loader {
            border-top-color: #22d3ee;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Modal Overlay */
        .modal-overlay {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, updateDoc, deleteDoc, doc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CLAVES ORIGINALES ---
        const API_KEY_GEMINI = "AIzaSyClcQiTJj91vzb0P5737owh4tUyJPLWgEA"; 
        
        // --- CONSTANTES DE BASE HIST√ìRICA ---
        const HISTORICAL_TOTAL = 43;
        const HISTORICAL_WPP = 32;
        const HISTORICAL_CALL = 0;

        const tecnicaturaMap = {
            'Desarrollo web': 1,
            'Administraci√≥n de empresas': 2,
            'Marketing': 3,
            'Higiene y seguridad': 4,
            'Gesti√≥n inmobiliaria': 5,
            'Analista de sistemas': 6,
            'Ciencia de datos e IA': 7,
            'Recursos humanos': 8
        };
        const tecnicaturaNameMap = Object.fromEntries(Object.entries(tecnicaturaMap).map(([key, value]) => [value, key]));

        const excelHeaders = [
            'ID', 'Nombre Completo', 'Email', 'Tel√©fono', 'Tecnicatura', 
            'Estado', 'Vendedor Asignado', 'Fecha de Creaci√≥n', '√öltimo Contacto', 'Observaciones'
        ];

        // --- PROMPT REFINADO PARA IGNORAR BASURA DE CHAT ---
        const systemPrompt = `
            Analiza el texto provisto. Es probable que sea un "copiar y pegar" sucio de WhatsApp.
            Tu misi√≥n es limpiar el ruido y extraer la informaci√≥n real del lead.

            INSTRUCCIONES DE LIMPIEZA:
            1. IGNORA l√≠neas de metadatos como: "[10:35 a.m., 2/12/2025]", "+54 9 ...:", nombres de remitentes repetidos en cabeceras.
            2. Extrae el NOMBRE real de la persona (suele estar en el cuerpo o en la cabecera si es √∫nico).
            3. Extrae el TEL√âFONO. Si hay varios (uno en cabecera y otro en cuerpo), prefiere el del cuerpo. L√≠mpialo: solo n√∫meros, sin espacios, sin guiones.
            4. CARRERA: Busca expl√≠citamente en el cuerpo del mensaje. Palabras clave:
               - "Analista", "Sistemas", "Computaci√≥n" -> Analista de sistemas
               - "Web", "Programaci√≥n" -> Desarrollo web
               - "Adm", "Empresas", "Negocios" -> Administraci√≥n de empresas
               - "Marketing", "Comercializaci√≥n" -> Marketing
               - "Higiene", "Seguridad" -> Higiene y seguridad
               - "Inmobiliaria", "Martillero" -> Gesti√≥n inmobiliaria
               - "Datos", "Data", "IA" -> Ciencia de datos e IA
               - "RRHH", "Recursos" -> Recursos humanos
            
            5. PREFERENCIA:
               - "telefono": Si dice expl√≠citamente llamar, celular, voz.
               - "whatsapp": Si dice escribir, mensaje, o por defecto si es un chat y no pide llamada.

            JSON SALIDA: { "nombre": str, "email": str, "telefono": str, "tecnicatura": str, "preferencia": "whatsapp"|"telefono"|null }
        `;

        const jsonSchema = {
            type: "OBJECT",
            properties: {
                "nombre": { "type": "STRING" },
                "email": { "type": "STRING" },
                "telefono": { "type": "STRING" },
                "tecnicatura": { "type": "STRING" },
                "preferencia": { "type": "STRING", "enum": ["whatsapp", "telefono"], "nullable": true }
            }
        };

        let db, auth, leadsRef;
        let allLeads = [];
        let activeLeads = [];
        let currentEditId = null;

        async function initApp() {
            try {
                const firebaseConfig = {
                    apiKey: API_KEY_GEMINI,
                    authDomain: "cargadeleads.firebaseapp.com",
                    projectId: "cargadeleads",
                    storageBucket: "cargadeleads.firebasestorage.app",
                    messagingSenderId: "744616190679",
                    appId: "1:744616190679:web:af63cbf7b42ee455a30692"
                };

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await signInAnonymously(auth);
                leadsRef = collection(db, 'leads'); 
                
                listenLeads();
            } catch (e) {
                alert("Error cr√≠tico de conexi√≥n: " + e.message);
            }
        }

        function listenLeads() {
            const q = query(leadsRef);
            onSnapshot(q, (snap) => {
                allLeads = [];
                snap.forEach(d => allLeads.push({ id: d.id, ...d.data() }));
                allLeads.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                renderUI();
            });
        }

        function renderUI() {
            activeLeads = allLeads.filter(l => !l.archivado);

            // Contadores
            const currentTotal = allLeads.length;
            const currentWpp = allLeads.filter(l => l.preferencia === 'whatsapp').length;
            const currentCall = allLeads.filter(l => l.preferencia === 'telefono').length;

            const totalFinal = HISTORICAL_TOTAL + currentTotal;
            const wppFinal = HISTORICAL_WPP + currentWpp;
            const callFinal = HISTORICAL_CALL + currentCall;

            const wppPct = totalFinal > 0 ? Math.round((wppFinal / totalFinal) * 100) : 0;
            const callPct = totalFinal > 0 ? Math.round((callFinal / totalFinal) * 100) : 0;

            document.getElementById('countTotal').textContent = totalFinal;
            document.getElementById('countWpp').textContent = `${wppPct}% (${wppFinal})`;
            document.getElementById('countCall').textContent = `${callPct}% (${callFinal})`;

            // Tabla
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            if(activeLeads.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="p-4 text-center text-gray-400">Bandeja de entrada limpia.</td></tr>';
            } else {
                activeLeads.forEach(lead => {
                    const row = document.createElement('tr');
                    const tecName = lead.tecnicaturaNombre || '-';
                    
                    let prefIcon = '';
                    if(lead.preferencia === 'whatsapp') prefIcon = '<span class="text-green-400 font-bold">WPP</span>';
                    if(lead.preferencia === 'telefono') prefIcon = '<span class="text-blue-400 font-bold">TEL</span>';

                    row.innerHTML = `
                        <td class="p-3 text-xs font-mono text-gray-400">${lead.id.substring(0,4)}</td>
                        <td class="p-3 font-medium">${lead.nombre}</td>
                        <td class="p-3 text-xs">${lead.email}</td>
                        <td class="p-3 text-xs">${lead.telefono}</td>
                        <td class="p-3 text-xs text-cyan-300">${tecName}</td>
                        <td class="p-3 text-xs">${prefIcon}</td>
                        <td class="p-3 text-xs">${lead.fecha}</td>
                        <td class="p-3 text-xs italic opacity-70 truncate max-w-[150px]">${lead.observacion}</td>
                        <td class="p-3 text-center flex justify-center gap-2">
                            <button onclick="window.editarLead('${lead.id}')" class="text-blue-400 hover:text-blue-200" title="Editar">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                            </button>
                            <button onclick="window.archivarLead('${lead.id}')" class="text-red-400 hover:text-red-200" title="Archivar">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
            
            document.getElementById('btnDownload').disabled = activeLeads.length === 0;
            document.getElementById('btnClean').disabled = activeLeads.length === 0;
        }

        window.procesar = async () => {
            const input = document.getElementById('inputMsg');
            const txt = input.value;
            if(!txt.trim()) return alert("Escribe algo.");
            
            toggleLoader(true);
            try {
                const parsed = await callGemini(txt);
                
                const tecName = normalizeTec(parsed.tecnicatura);
                const tecId = tecnicaturaMap[tecName] || '';
                // Por defecto, si viene de un chat sucio y no dice nada, asumimos WPP para que cuente
                const pref = parsed.preferencia || 'whatsapp'; 
                
                let obsText = "Consulta general.";
                if (pref === 'whatsapp') obsText = "Manifiesta que la contacten por WhatsApp.";
                if (pref === 'telefono') obsText = "Manifiesta que prefiere por esa v√≠a (Llamada).";
                obsText += " Consulta por WhatsApp";

                const newDoc = {
                    nombre: parsed.nombre || 'Desconocido',
                    email: parsed.email || '',
                    telefono: parsed.telefono || '',
                    tecnicaturaNombre: tecName,
                    tecnicaturaId: tecId,
                    preferencia: pref,
                    observacion: obsText,
                    fecha: new Date().toLocaleDateString('es-AR'),
                    timestamp: Date.now(),
                    archivado: false,
                    estado: 'Nuevo',
                    vendedor: ''
                };

                await addDoc(leadsRef, newDoc);
                input.value = '';
                
            } catch (e) {
                console.error(e);
                alert("Error procesando: " + e.message);
            } finally {
                toggleLoader(false);
            }
        };

        // --- EDICI√ìN ---
        window.editarLead = (id) => {
            const lead = allLeads.find(l => l.id === id);
            if(!lead) return;
            currentEditId = id;
            
            document.getElementById('editNombre').value = lead.nombre;
            document.getElementById('editEmail').value = lead.email;
            document.getElementById('editTelefono').value = lead.telefono;
            document.getElementById('editTecnicatura').value = lead.tecnicaturaNombre;
            document.getElementById('editPreferencia').value = lead.preferencia || "";
            document.getElementById('editObservacion').value = lead.observacion;
            
            document.getElementById('editModal').classList.remove('hidden');
            document.getElementById('editModal').classList.add('flex');
        };

        window.guardarEdicion = async () => {
            if(!currentEditId) return;
            
            const tecName = document.getElementById('editTecnicatura').value;
            const tecId = tecnicaturaMap[tecName] || '';
            const pref = document.getElementById('editPreferencia').value;
            
            const updatedData = {
                nombre: document.getElementById('editNombre').value,
                email: document.getElementById('editEmail').value,
                telefono: document.getElementById('editTelefono').value,
                tecnicaturaNombre: tecName,
                tecnicaturaId: tecId,
                preferencia: pref,
                observacion: document.getElementById('editObservacion').value
            };
            
            toggleLoader(true);
            try {
                await updateDoc(doc(db, 'leads', currentEditId), updatedData);
                cerrarModal();
            } catch(e) {
                alert("Error al guardar: " + e.message);
            } finally {
                toggleLoader(false);
            }
        };

        window.cerrarModal = () => {
            document.getElementById('editModal').classList.add('hidden');
            document.getElementById('editModal').classList.remove('flex');
            currentEditId = null;
        };

        window.archivarLead = async (id) => {
            if(!confirm("¬øArchivar?")) return;
            await updateDoc(doc(db, 'leads', id), { archivado: true });
        };

        window.limpiarPantalla = async () => {
            if(!confirm("Archivar TODO lo visible?")) return;
            const batch = writeBatch(db);
            activeLeads.forEach(l => {
                batch.update(doc(db, 'leads', l.id), { archivado: true });
            });
            await batch.commit();
        };

        window.descargarExcel = () => {
            const data = activeLeads.map(l => ({
                'ID': l.id.substring(0,5),
                'Nombre Completo': l.nombre,
                'Email': l.email,
                'Tel√©fono': l.telefono,
                'Tecnicatura': l.tecnicaturaId,
                'Estado': l.estado,
                'Vendedor Asignado': l.vendedor,
                'Fecha de Creaci√≥n': l.fecha,
                '√öltimo Contacto': '',
                'Observaciones': l.observacion
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Leads");
            XLSX.writeFile(wb, "Leads_Cervantes.xlsx");
        };

        function normalizeTec(raw) {
            if(!raw) return '';
            const s = raw.toLowerCase();
            if(s.includes('web') || s.includes('prog')) return 'Desarrollo web';
            if(s.includes('adm') || s.includes('empresa')) return 'Administraci√≥n de empresas';
            if(s.includes('mkt') || s.includes('market')) return 'Marketing';
            if(s.includes('hig') || s.includes('segur')) return 'Higiene y seguridad';
            if(s.includes('inmob') || s.includes('marti')) return 'Gesti√≥n inmobiliaria';
            if(s.includes('sist') || s.includes('analist')) return 'Analista de sistemas';
            if(s.includes('dat') || s.includes('ia')) return 'Ciencia de datos e IA';
            if(s.includes('rrhh') || s.includes('recurs')) return 'Recursos humanos';
            return raw; // Retorna original si no matchea para editarlo luego
        }

        async function callGemini(text) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY_GEMINI}`;
            const body = {
                contents: [{ parts: [{ text }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: { responseMimeType: "application/json", responseSchema: jsonSchema }
            };
            
            const r = await fetch(url, { method: 'POST', body: JSON.stringify(body), headers: {'Content-Type':'application/json'} });
            if (!r.ok) throw new Error(`API Error: ${r.status}`);
            
            const j = await r.json();
            if (!j.candidates || j.candidates.length === 0) throw new Error("No se pudo interpretar el texto.");
            
            return JSON.parse(j.candidates[0].content.parts[0].text);
        }

        function toggleLoader(show) {
            document.getElementById('loaderOverlay').style.display = show ? 'flex' : 'none';
        }

        document.addEventListener('DOMContentLoaded', initApp);
        
        // Paste Handler
        document.addEventListener('paste', (e) => {
            const items = e.clipboardData.items;
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf("image") !== -1) {
                    const blob = items[i].getAsFile();
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        toggleLoader(true);
                        const base64 = event.target.result.split(',')[1];
                        try {
                            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY_GEMINI}`;
                            const body = {
                                contents: [{ parts: [{text: "Extrae JSON limpio"}, {inlineData: {mimeType: blob.type, data: base64}}] }],
                                systemInstruction: { parts: [{ text: systemPrompt }] },
                                generationConfig: { responseMimeType: "application/json", responseSchema: jsonSchema }
                            };
                            const r = await fetch(url, { method: 'POST', body: JSON.stringify(body), headers: {'Content-Type':'application/json'} });
                            const j = await r.json();
                            const parsed = JSON.parse(j.candidates[0].content.parts[0].text);
                            
                            const tecName = normalizeTec(parsed.tecnicatura);
                            const tecId = tecnicaturaMap[tecName] || '';
                            const pref = parsed.preferencia || 'whatsapp';
                            
                            let obsText = "Consulta general.";
                            if (pref === 'whatsapp') obsText = "Manifiesta que la contacten por WhatsApp.";
                            if (pref === 'telefono') obsText = "Manifiesta que prefiere por esa v√≠a (Llamada).";
                            obsText += " Consulta por WhatsApp";

                            const newDoc = {
                                nombre: parsed.nombre || 'Desconocido',
                                email: parsed.email || '',
                                telefono: parsed.telefono || '',
                                tecnicaturaNombre: tecName,
                                tecnicaturaId: tecId,
                                preferencia: pref,
                                observacion: obsText,
                                fecha: new Date().toLocaleDateString('es-AR'),
                                timestamp: Date.now(),
                                archivado: false,
                                estado: 'Nuevo',
                                vendedor: ''
                            };
                            await addDoc(leadsRef, newDoc);
                        } catch(e) { console.error(e); alert("Error imagen: " + e.message); }
                        finally { toggleLoader(false); }
                    };
                    reader.readAsDataURL(blob);
                }
            }
        });
    </script>
</head>
<body class="p-6">

    <!-- Loader -->
    <div id="loaderOverlay" class="fixed inset-0 bg-black/80 z-50 hidden flex-col items-center justify-center backdrop-blur-sm">
        <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-16 w-16 mb-4"></div>
        <h2 class="text-cyan-400 font-bold text-xl animate-pulse">Procesando Lead...</h2>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="fixed inset-0 z-50 hidden items-center justify-center modal-overlay p-4">
        <div class="glass-panel p-6 w-full max-w-lg bg-slate-900/90 border border-white/20 relative">
            <button onclick="window.cerrarModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white">‚úï</button>
            <h3 class="text-xl font-bold text-cyan-400 mb-4">Editar Lead</h3>
            <div class="space-y-3">
                <div>
                    <label class="text-xs uppercase text-gray-400">Nombre</label>
                    <input type="text" id="editNombre" class="glass-input w-full p-2 rounded">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs uppercase text-gray-400">Email</label>
                        <input type="text" id="editEmail" class="glass-input w-full p-2 rounded">
                    </div>
                    <div>
                        <label class="text-xs uppercase text-gray-400">Tel√©fono</label>
                        <input type="text" id="editTelefono" class="glass-input w-full p-2 rounded">
                    </div>
                </div>
                <div>
                    <label class="text-xs uppercase text-gray-400">Carrera (Tecnicatura)</label>
                    <select id="editTecnicatura" class="glass-input w-full p-2 rounded">
                        <option value="">- Seleccionar -</option>
                        <option value="Desarrollo web">Desarrollo web</option>
                        <option value="Administraci√≥n de empresas">Administraci√≥n de empresas</option>
                        <option value="Marketing">Marketing</option>
                        <option value="Higiene y seguridad">Higiene y seguridad</option>
                        <option value="Gesti√≥n inmobiliaria">Gesti√≥n inmobiliaria</option>
                        <option value="Analista de sistemas">Analista de sistemas</option>
                        <option value="Ciencia de datos e IA">Ciencia de datos e IA</option>
                        <option value="Recursos humanos">Recursos humanos</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs uppercase text-gray-400">Preferencia</label>
                    <select id="editPreferencia" class="glass-input w-full p-2 rounded">
                        <option value="">- Ninguna -</option>
                        <option value="whatsapp">WhatsApp</option>
                        <option value="telefono">Tel√©fono</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs uppercase text-gray-400">Observaciones</label>
                    <textarea id="editObservacion" class="glass-input w-full p-2 rounded h-20"></textarea>
                </div>
                <div class="flex justify-end gap-2 mt-4">
                    <button onclick="window.cerrarModal()" class="btn-secondary px-4 py-2 rounded text-sm">Cancelar</button>
                    <button onclick="window.guardarEdicion()" class="btn-success px-4 py-2 rounded text-sm">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto space-y-6">
        
        <!-- Header -->
        <header class="flex justify-between items-end pb-4 border-b border-white/10">
            <div>
                <h1 class="text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-cyan-300 to-blue-400">
                    Procesador de Leads
                </h1>
                <p class="text-blue-200 opacity-80 mt-1">Versi√≥n 8.3 ‚Ä¢ Clean Parse & Edit</p>
            </div>
        </header>

        <!-- Stats Panel -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="glass-panel p-6 flex flex-col items-center justify-center">
                <span class="text-blue-300 text-sm font-bold uppercase tracking-widest">Total Procesados (Hist√≥rico)</span>
                <span id="countTotal" class="text-5xl font-bold text-white mt-2 drop-shadow-lg">43</span>
            </div>
            <div class="glass-panel p-6 flex flex-col items-center justify-center border-l-4 border-green-400">
                <span class="text-green-300 text-sm font-bold uppercase tracking-widest">WhatsApp</span>
                <span id="countWpp" class="text-5xl font-bold text-green-400 mt-2 drop-shadow-lg">74% (32)</span>
            </div>
            <div class="glass-panel p-6 flex flex-col items-center justify-center border-l-4 border-blue-400">
                <span class="text-blue-300 text-sm font-bold uppercase tracking-widest">Llamados</span>
                <span id="countCall" class="text-5xl font-bold text-blue-400 mt-2 drop-shadow-lg">0% (0)</span>
            </div>
        </div>

        <!-- Main Area -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[600px]">
            
            <!-- Input Area -->
            <div class="glass-panel p-6 flex flex-col gap-4">
                <h2 class="text-xl font-bold text-cyan-100 flex items-center gap-2">
                    <span>üì•</span> Ingreso de Datos
                </h2>
                <textarea id="inputMsg" class="glass-input w-full flex-grow rounded-xl p-4 resize-none text-sm leading-relaxed" 
                    placeholder="Pega aqu√≠ el mensaje de WhatsApp, correo o presiona CTRL+V para pegar una imagen..."></textarea>
                <button onclick="procesar()" class="btn-action py-3 rounded-xl shadow-lg text-lg flex items-center justify-center gap-2">
                    <span>‚ú®</span> Procesar con IA
                </button>
            </div>

            <!-- Table Area -->
            <div class="glass-panel p-6 lg:col-span-2 flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-cyan-100">Bandeja de Entrada (Activos)</h2>
                    <div class="flex gap-2">
                        <button id="btnClean" onclick="limpiarPantalla()" disabled class="btn-danger px-4 py-2 rounded-lg text-sm shadow-lg font-bold">
                            üßπ Limpiar Pantalla (Archivar)
                        </button>
                        <button id="btnDownload" onclick="descargarExcel()" disabled class="btn-success px-4 py-2 rounded-lg text-sm shadow-lg font-bold flex items-center gap-2">
                            <span>üìä</span> Descargar Excel
                        </button>
                    </div>
                </div>
                
                <div class="overflow-auto flex-grow rounded-lg border border-white/10">
                    <table class="w-full glass-table text-left border-collapse">
                        <thead class="sticky top-0 z-10 backdrop-blur-md">
                            <tr>
                                <th class="p-3">ID</th>
                                <th class="p-3">Nombre</th>
                                <th class="p-3">Email</th>
                                <th class="p-3">Tel</th>
                                <th class="p-3">Tec</th>
                                <th class="p-3">Pref</th>
                                <th class="p-3">Fecha</th>
                                <th class="p-3">Obs</th>
                                <th class="p-3 text-center">Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <!-- JS Injected -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

</body>
</html>
