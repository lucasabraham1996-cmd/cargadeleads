<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeadExtractor Pro - Versión Ligera</title>
    
    <!-- 1. Tailwind CSS (Diseño) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Excel (SheetJS) -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <!-- 3. OCR (Tesseract.js) -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

    <!-- Iconos (Feather Icons - Ligero) -->
    <script src="https://unpkg.com/feather-icons"></script>

    <style>
        body { background-color: #f0f2f5; font-family: -apple-system, system-ui, sans-serif; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #22c55e; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Animación suave */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-slate-800">

    <!-- Notificación Toast -->
    <div id="toast" class="fixed bottom-5 right-5 bg-slate-800 text-white px-6 py-3 rounded-xl shadow-2xl transform translate-y-20 transition-transform duration-300 z-50 flex items-center gap-3 font-medium text-sm">
        <span id="toast-icon"></span>
        <span id="toast-message">Mensaje</span>
    </div>

    <!-- Contenedor Principal -->
    <div class="max-w-7xl mx-auto p-4 md:p-6 min-h-screen flex flex-col gap-6">
        
        <!-- Header -->
        <header class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="bg-green-500 p-2 rounded-xl text-white shadow">
                    <i data-feather="clipboard" class="w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight text-slate-800">LeadExtractor Pro</h1>
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">HTML Nativo • Sin React</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="copySummary()" class="bg-blue-50 text-blue-600 hover:bg-blue-100 px-4 py-2 rounded-xl font-bold text-xs flex items-center gap-2 transition-colors">
                    <i data-feather="copy" class="w-4 h-4"></i> Copiar Todo
                </button>
                <button onclick="exportToExcel()" class="bg-slate-800 hover:bg-black text-white px-5 py-2 rounded-xl font-bold text-xs flex items-center gap-2 shadow-lg transition-transform active:scale-95">
                    <i data-feather="download" class="w-4 h-4"></i> Excel
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- Panel Izquierdo: Captura -->
            <section class="lg:col-span-4 flex flex-col gap-4">
                <div id="drop-zone" class="bg-white p-6 rounded-3xl shadow-lg border-2 border-white transition-all duration-300">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2">
                            <span id="status-icon"><i data-feather="image" class="w-4 h-4 text-blue-500"></i></span>
                            <span id="status-text">Área de Captura</span>
                        </h3>
                    </div>

                    <!-- Área Interactiva -->
                    <div class="relative w-full h-48 bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200 hover:border-green-400 transition-colors cursor-pointer overflow-hidden group">
                        <textarea id="paste-input" class="absolute inset-0 w-full h-full p-6 bg-transparent resize-none text-xs focus:outline-none z-10 text-center flex items-center justify-center placeholder:text-transparent text-slate-600 font-medium" placeholder="Pega aquí..."></textarea>
                        
                        <!-- Placeholder Visual -->
                        <div id="paste-placeholder" class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none transition-opacity duration-200">
                            <div class="bg-white p-3 rounded-full shadow-sm mb-2 group-hover:scale-110 transition-transform">
                                <i data-feather="zap" class="w-6 h-6 text-slate-300 group-hover:text-green-500"></i>
                            </div>
                            <p class="text-xs font-bold text-slate-500">Haz Clic y CTRL+V</p>
                            <span class="text-[10px] text-slate-400 font-medium mt-1">Imagen o Texto</span>
                        </div>
                    </div>
                </div>

                <!-- Referencia de Colores -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                    <h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-3">Referencias</h4>
                    <div class="grid grid-cols-2 gap-2" id="legend-container">
                        <!-- Se llena con JS -->
                    </div>
                </div>
            </section>

            <!-- Panel Derecho: Tabla -->
            <section class="lg:col-span-8">
                <div class="bg-white rounded-3xl shadow-lg border border-slate-100 overflow-hidden min-h-[500px] flex flex-col">
                    <div class="p-5 border-b border-slate-50 flex justify-between items-center bg-slate-50/50">
                        <span class="font-bold text-xs uppercase text-slate-500 tracking-wider">Registros: <span id="row-count">0</span></span>
                        <button onclick="addManualRow()" class="text-blue-600 bg-blue-50 hover:bg-blue-100 px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase tracking-wide flex items-center gap-1 transition-colors">
                            <i data-feather="plus" class="w-3 h-3"></i> Manual
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto flex-1">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 text-slate-400 uppercase text-[9px] font-black tracking-widest sticky top-0 z-10">
                                <tr>
                                    <th class="px-6 py-4">Datos del Prospecto</th>
                                    <th class="px-6 py-4">Contacto</th>
                                    <th class="px-6 py-4">Carrera</th>
                                    <th class="px-4 py-4 text-right"></th>
                                </tr>
                            </thead>
                            <tbody id="table-body" class="divide-y divide-slate-50">
                                <!-- Filas generadas por JS -->
                            </tbody>
                        </table>
                        
                        <!-- Estado Vacío -->
                        <div id="empty-state" class="flex flex-col items-center justify-center py-20 text-slate-300">
                            <i data-feather="inbox" class="w-12 h-12 mb-3 opacity-50"></i>
                            <p class="font-medium text-sm italic">Esperando datos...</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- LÓGICA DE LA APLICACIÓN (Vanilla JS) -->
    <script>
        // --- Configuración y Datos ---
        const CareerMapper = {
            1: { label: 'Desarrollo web', color: '#b8a68e', keywords: ['desarrollo de web', 'desarrollo web', 'programacion', 'full stack', 'backend', 'frontend', 'dw', 'software', 'codigo'] },
            2: { label: 'Administración de empresas', color: '#859f4f', keywords: ['administracion', 'administración', 'admin', 'empresas', 'ae', 'negocios', 'gestion', 'contable'] },
            3: { label: 'Marketing', color: '#ff7b1c', keywords: ['marketing', 'mercadeo', 'publicidad', 'mkt', 'redes', 'community', 'digital'] },
            4: { label: 'Higiene y seguridad', color: '#fbc42b', keywords: ['higiene', 'seguridad', 'prevencion', 'prevención', 'hys', 'riesgos'] },
            5: { label: 'Gestión inmobiliaria', color: '#be2528', keywords: ['gestion inmobiliaria', 'tasacion', 'tasación', 'cotizacion', 'inmobiliaria', 'legales', 'negociacion', 'gi', 'martillero', 'corredor'] },
            6: { label: 'Analista de sistemas', color: '#00adef', keywords: ['analista', 'sistemas', 'asc', 'informatica', 'computacion'] },
            7: { label: 'Ciencia de datos e IA', color: '#405ba8', keywords: ['inteligencia artificial', 'ia', 'datos', 'data', 'science', 'machine learning'] },
            8: { label: 'Recursos humanos', color: '#c397c6', keywords: ['recursos humanos', 'rrhh', 'personal', 'talento', 'rh', 'seleccion'] }
        };

        let rows = [];
        let isProcessing = false;

        // --- Inicialización ---
        document.addEventListener('DOMContentLoaded', () => {
            feather.replace();
            renderLegend();
            setupPasteListener();
        });

        // --- Lógica de Parsing Inteligente ---
        function parseTextToData(text) {
            const lowerText = text.toLowerCase();
            const normalizedText = lowerText.normalize("NFD").replace(/[\u0300-\u036f]/g, "");

            // 1. Email
            const emailMatch = text.match(/[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}/g);
            const email = emailMatch ? emailMatch[0] : '';

            // 2. Teléfono (Prioridad WA)
            let validPhone = '';
            const phones = text.match(/(\+?\d{1,3}[\s-]?9?[\s-]?\d{1,4}[\s-]?\d{2,4}[\s-]?\d{2,6})/g);
            if (phones) {
                const cleaned = phones.map(p => ({ org: p, val: p.replace(/\D/g, '') }));
                // Priorizar +54 o el más largo
                const best = cleaned.find(p => p.val.startsWith('54')) || cleaned.sort((a,b) => b.val.length - a.val.length)[0];
                validPhone = best ? best.org : '';
            }

            // 3. Carrera (Sistema de Puntos)
            let bestId = '', maxScore = 0;
            for (const [id, data] of Object.entries(CareerMapper)) {
                let score = 0;
                data.keywords.forEach(k => {
                    const normK = k.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                    if (normalizedText.includes(normK)) score += k.length > 3 ? 2 : 1; 
                });
                if (score > maxScore) { maxScore = score; bestId = id; }
            }

            // 4. Nombre
            const blackList = ['hola','interesa','quiero','info','precio','mensaje','cifrados','ayer','hoy','anuncio','facebook','cervantes','clic','error','foto','escribiendo','linea','bloquear','seguridad','contacto','perfil','cuenta','business', 'vez'];
            
            // Eliminar email y teléfono para no confundir
            let clean = text.replace(email, '').replace(validPhone, '');
            const lines = clean.split(/[\n]/).map(l => l.trim()).filter(l => l.length > 2);
            
            let likelyName = 'SIN NOMBRE';
            // Buscar en las primeras 6 líneas
            const candidate = lines.slice(0, 6).find(l => {
                const low = l.toLowerCase();
                const hasDigit = /\d/.test(l);
                const isBlacklisted = blackList.some(b => low.includes(b));
                const words = l.split(' ').length;
                return !hasDigit && !isBlacklisted && words <= 4 && !l.includes(':');
            });

            if (candidate) {
                const n = candidate.replace(/[^a-zA-Z\s\u00C0-\u00FF]/g, '').trim().toUpperCase();
                if (n.length > 2) likelyName = n;
            }

            return {
                id: Date.now(),
                nombre: likelyName,
                telefono: validPhone.trim(),
                email: email,
                tecnicaturaId: bestId,
                fuente: 'WhatsApp Comercial',
                provincia: '',
                estado: 'sin_contacto',
                observaciones: '',
                vendedorId: ''
            };
        }

        // --- Procesamiento de Pegado y OCR ---
        function setupPasteListener() {
            const input = document.getElementById('paste-input');
            const dropZone = document.getElementById('drop-zone');

            // Click para enfocar
            dropZone.addEventListener('click', () => input.focus());

            input.addEventListener('paste', async (e) => {
                e.stopPropagation();
                e.preventDefault();

                const items = e.clipboardData.items;
                let imageFound = false;

                // Buscar imagen
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        const blob = items[i].getAsFile();
                        processImage(blob);
                        imageFound = true;
                        break;
                    }
                }

                // Si no es imagen, es texto
                if (!imageFound) {
                    const text = e.clipboardData.getData('text');
                    if (text) {
                        const data = parseTextToData(text);
                        addRow(data);
                        showToast('Texto procesado', 'check');
                    }
                }
                
                // Limpiar input visualmente
                input.value = ''; 
            });
        }

        async function processImage(blob) {
            setLoading(true);
            showToast('Analizando imagen...', 'loader');
            
            try {
                if (!window.Tesseract) throw new Error("OCR no cargado");
                
                // Configuración segura para evitar errores de URL
                const result = await Tesseract.recognize(blob, 'spa', {
                    logger: m => console.log(m)
                });
                
                const data = parseTextToData(result.data.text);
                addRow(data);
                showToast('Lead capturado', 'check');
            } catch (err) {
                console.error(err);
                showToast('Error al leer imagen', 'alert-triangle');
            } finally {
                setLoading(false);
            }
        }

        // --- Gestión de la UI ---
        function addRow(data) {
            rows.push(data);
            renderTable();
        }

        function addManualRow() {
            const emptyData = { ...parseTextToData(''), nombre: 'SIN NOMBRE', id: Date.now() };
            addRow(emptyData);
        }

        function updateRow(id, field, value) {
            const row = rows.find(r => r.id === id);
            if (row) {
                row[field] = value;
                // Re-renderizar si cambia la carrera para actualizar colores
                if (field === 'tecnicaturaId') renderTable(); 
            }
        }

        function deleteRow(id) {
            rows = rows.filter(r => r.id !== id);
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('table-body');
            const emptyState = document.getElementById('empty-state');
            const countSpan = document.getElementById('row-count');
            
            tbody.innerHTML = '';
            countSpan.textContent = rows.length;

            if (rows.length === 0) {
                emptyState.style.display = 'flex';
                return;
            }
            emptyState.style.display = 'none';

            rows.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'group hover:bg-slate-50 transition-colors fade-in';
                
                const careerColor = CareerMapper[row.tecnicaturaId]?.color || '#cbd5e1';
                const careerLabel = CareerMapper[row.tecnicaturaId]?.label || '';

                // Construcción de opciones del select
                let optionsHtml = '<option value="">-- Detectar --</option>';
                for (const [id, data] of Object.entries(CareerMapper)) {
                    const selected = row.tecnicaturaId == id ? 'selected' : '';
                    optionsHtml += `<option value="${id}" ${selected}>${data.label}</option>`;
                }

                tr.innerHTML = `
                    <td class="px-6 py-4">
                        <input onchange="updateRow(${row.id}, 'nombre', this.value)" 
                               class="font-black text-sm bg-transparent w-full focus:outline-none focus:bg-white rounded px-1 ${row.nombre === 'SIN NOMBRE' ? 'text-slate-300 italic' : 'text-slate-800'}" 
                               value="${row.nombre}">
                        <input onchange="updateRow(${row.id}, 'email', this.value)" 
                               class="text-[10px] font-bold text-slate-400 bg-transparent w-full focus:outline-none mt-1 focus:bg-white rounded px-1" 
                               value="${row.email}" placeholder="Sin Email">
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-2 text-green-600 font-mono font-bold text-xs bg-green-50 px-2 py-1 rounded-lg w-fit">
                            <i data-feather="phone" class="w-3 h-3 opacity-70"></i>
                            <input onchange="updateRow(${row.id}, 'telefono', this.value)" 
                                   class="bg-transparent w-24 focus:outline-none" 
                                   value="${row.telefono}">
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-2">
                            <div class="w-2 h-8 rounded-full shadow-sm transition-colors duration-300" style="background-color: ${careerColor}"></div>
                            <select onchange="updateRow(${row.id}, 'tecnicaturaId', this.value)" 
                                    class="font-bold bg-transparent text-[11px] uppercase cursor-pointer focus:outline-none w-36 py-1"
                                    style="color: ${careerColor === '#fbc42b' ? '#b78900' : careerColor}"> <!-- Ajuste contraste amarillo -->
                                ${optionsHtml}
                            </select>
                        </div>
                    </td>
                    <td class="px-4 py-4 text-right">
                        <button onclick="deleteRow(${row.id})" class="text-slate-300 hover:text-red-500 p-2 transition-colors">
                            <i data-feather="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            feather.replace();
        }

        function renderLegend() {
            const container = document.getElementById('legend-container');
            let html = '';
            for (const [id, data] of Object.entries(CareerMapper)) {
                html += `
                    <div class="flex items-center gap-2 text-[10px] text-slate-500 font-medium">
                        <span class="w-2 h-2 rounded-full" style="background-color: ${data.color}"></span>
                        ${data.label.split(' ')[0]}
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        function setLoading(state) {
            isProcessing = state;
            const dropZone = document.getElementById('drop-zone');
            const icon = document.getElementById('status-icon');
            const text = document.getElementById('status-text');
            const placeholder = document.getElementById('paste-placeholder');

            if (state) {
                dropZone.classList.add('border-green-500', 'bg-green-50');
                dropZone.classList.remove('border-white');
                icon.innerHTML = '<div class="loader"></div>';
                text.textContent = 'Procesando...';
                placeholder.classList.add('opacity-50');
            } else {
                dropZone.classList.remove('border-green-500', 'bg-green-50');
                dropZone.classList.add('border-white');
                icon.innerHTML = '<i data-feather="image" class="w-4 h-4 text-blue-500"></i>';
                text.textContent = 'Área de Captura';
                placeholder.classList.remove('opacity-50');
                feather.replace();
            }
        }

        // --- Utilidades ---
        function exportToExcel() {
            if (rows.length === 0) return showToast('No hay datos', 'x-circle');
            
            const dataToExport = rows.map(r => ({
                'Nombre Completo': r.nombre,
                'Teléfono': r.telefono,
                'Email': r.email,
                'Tecnicatura ID': r.tecnicaturaId,
                'Fuente': 'WhatsApp Comercial',
                'Provincia': r.provincia,
                'Estado': 'sin_contacto',
                'Observaciones': '',
                'Vendedor ID': r.vendedorId
            }));

            const ws = XLSX.utils.json_to_sheet(dataToExport);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Leads");
            XLSX.writeFile(wb, `Leads_WA_${new Date().toISOString().slice(0,10)}.xlsx`);
            showToast('Descargando Excel...', 'download');
        }

        function copySummary() {
            if (rows.length === 0) return showToast('Nada para copiar', 'x-circle');
            const text = rows.map(r => `${r.nombre}\t${r.telefono}\t${r.tecnicaturaId ? CareerMapper[r.tecnicaturaId].label : 'S/D'}`).join('\n');
            navigator.clipboard.writeText(text).then(() => showToast('Copiado al portapapeles', 'clipboard'));
        }

        function showToast(message, iconName = 'info') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            const msg = document.getElementById('toast-message');

            icon.innerHTML = `<i data-feather="${iconName}" class="w-4 h-4"></i>`;
            msg.textContent = message;
            feather.replace();

            toast.classList.remove('translate-y-20');
            setTimeout(() => {
                toast.classList.add('translate-y-20');
            }, 3000);
        }
    </script>
</body>
</html>
